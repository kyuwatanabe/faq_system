# FAQ自動生成システム - 作業再開用ドキュメント（2025-10-09）

## 現在の状況

### 🔴 未解決の重大問題
**FAQ生成で同じトピックばかり生成される問題が解決していない**

- 第2章.pdfは13ページ、19,288文字（20,000文字制限内で全文カバー済み）
- プロンプトに「PDFドキュメント全体から均等に...」と明示的に指示済み
- 既存質問との重複チェックも機能している（承認待ち10件を正しく読み込んでいる）
- **にもかかわらず、生成される質問はビザウェーバープログラム関連ばかり**

### 実際の生成結果（2025-10-09 07:58）

**1回目（既存0件）**:
- 10件中ほぼ全てがビザウェーバープログラム関連
- 例: 「ビザウェーバープログラムとはどのようなものですか?」

**2回目（既存10件）**:
- 承認待ち10件を正しく読み込み、重複チェック実施
- それでも生成された質問:
  - 「ビザの有効期限と滞在期限の違いは何ですか?」
  - 「I-94とは何ですか?その役割は何ですか?」
  - など、まともなトピックもあるが、重複傾向あり

**ログ証拠**:
```
[DEBUG] 重複チェック対象 - 既存FAQ: 0件, 承認待ち: 10件
[DEBUG] ユニークな既存質問: 10件
```
↑ 重複チェックは機能しているのに、同じトピックが生成される

## 技術的な現状

### ✅ 正常動作している機能
1. **Claude API統合**: Haiku モデル (claude-3-haiku-20240307) で動作確認済み
2. **PDF読み込み**: 第2章.pdf 全文 (19,288文字) を正しく読み込み
3. **重複チェック**: 承認済みFAQ + 承認待ちFAQとの重複を正しくチェック
4. **履歴管理**: 生成履歴ファイルチェックを削除し、承認済み+承認待ちのみでチェック
5. **デバッグモード**: ボタン1つで第2章.pdfから10個生成
6. **デプロイ**: Railwayに自動デプロイ、reference_docs/もアップロード済み

### ❌ 未解決の問題
1. **トピック多様性の欠如**: プロンプトの指示が無視されている
   - 「PDFドキュメント全体から均等にトピックを選んでください」と書いても効果なし
   - 特定トピック（ビザウェーバー）に偏る

### 使用中のモデル設定
- **モデル**: `claude-3-haiku-20240307` (Sonnetは404エラーのため使用不可)
- **max_tokens**: 4096 (Haikuの上限)
- **temperature**: 指定なし（デフォルト）

## 関連ファイルとコード

### 重要なファイル
1. **faq_system.py**: FAQ生成ロジック本体
   - Line 751-754: プロンプト（均等分散指示を追加済み）
   - Line 713-739: 重複チェック（履歴削除済み、承認済み+承認待ちのみ）
   - Line 755: PDF読み込み（20,000文字）
   - Line 812-814: モデル設定（Haiku, 4096 tokens）

2. **web_app.py**: Flask Webアプリ
   - Line 414-430: DEBUG_MODE（第2章.pdf固定、10個生成）
   - Line 83-97: 履歴クリアエンドポイント

3. **templates/auto_generate_faq.html**: UI
   - デバッグモード用シンプルUI（ボタン1つ）
   - 履歴クリアボタンあり

### 現在のプロンプト（faq_system.py: 751-754）
```python
【タスク】
上記の★既存質問と意味が重複しない、完全に異なるトピックのFAQを以下のPDFドキュメントから{num_questions}個生成してください。

**重要**: PDFドキュメント全体から均等にトピックを選んでください。特定のトピック（例: ビザウェーバープログラム）だけでなく、PDFに含まれる全てのセクション（ビザの基礎、有効期限と滞在期限、I-94、オーバーステイ、商用と就労の違い、Automatic Revalidationなど）から質問を生成してください。
```
↑ **この指示が無視されている**

### 重複チェックロジック（faq_system.py: 713-739）
```python
# 既存のFAQと承認待ちQ&Aの両方をチェック（重複を避けるため）
existing_questions = [faq['question'] for faq in self.faq_data]

# 承認待ちQ&Aも読み込んで追加
self.load_pending_qa()
pending_questions = [item['question'] for item in self.pending_qa if 'question' in item]

# 既存FAQと承認待ちのみを統合（履歴は使わない）
all_existing_questions = existing_questions + pending_questions
```

## これまでの試行錯誤

### 試したこと（全て失敗）
1. ✗ PDF読み込み文字数を8000→20000に増加
2. ✗ プロンプトに「均等に分散」指示を追加
3. ✗ モデルをSonnet→Haikuに変更
4. ✗ 履歴ファイルチェックを削除（承認済み+承認待ちのみ）

### 未検証の仮説
1. **Haikuモデルの限界**: Haikuは指示に従う能力が低い可能性
   - Sonnetを使いたいが、404エラーで使用不可
   - モデル名の調査が必要

2. **temperature設定**: 現在未指定（デフォルト値使用）
   - 低すぎると同じパターンを繰り返す可能性
   - 0.7-1.0の範囲で試す価値あり

3. **プロンプト構造**: Few-shot exampleがない
   - 「こういう質問を生成してほしい」という具体例を示していない
   - 例示を追加すれば改善する可能性

4. **出力形式の制約**: JSON形式で10個一度に生成
   - 1個ずつ生成して多様性を確保する方法もあり

## 次回作業時の手順

### 1. 作業再開コマンド
```bash
cd "C:\Users\GF001\Desktop\システム開発\手引き用チャットボット\faq_system"
```

### 2. Claudeに伝えるメッセージ
```
SESSION_RESUME_2.mdを読んで、FAQ生成でトピックが偏る問題を解決して
```

### 3. 推奨される次のアクション（優先順位順）

#### Option A: 利用可能なClaudeモデルを調査
```bash
# Anthropic APIドキュメントで最新のモデル名を確認
# Sonnet 3.5の正しいモデル名を特定して使用
```
**理由**: Haikuは指示追従能力が低い。Sonnetなら改善する可能性が高い。

#### Option B: temperature設定を追加
`faq_system.py` Line 812-814を編集:
```python
data = {
    'model': 'claude-3-haiku-20240307',
    'max_tokens': 4096,
    'temperature': 0.9,  # 追加: 多様性を高める
```
**理由**: デフォルトのtemperatureが低すぎて同じパターンを繰り返している可能性。

#### Option C: Few-shot exampleをプロンプトに追加
`faq_system.py` Line 751-754のプロンプトに例示を追加:
```
【期待する出力例】
- ビザウェーバープログラムとは何ですか?
- ビザの有効期限と滞在期限の違いは?
- I-94とは何ですか?
- オーバーステイするとどうなりますか?
- 商用目的と就労の違いは何ですか?
- Automatic Revalidationとは?

上記のように、異なるセクションから均等に質問を生成してください。
```

#### Option D: 複数回の小規模生成
- 現在: 10個を1回で生成
- 変更案: 2個を5回生成（毎回プロンプトを微調整）

### 4. テスト手順
1. コード変更後、ローカルでテスト不要（Railway直行）
2. `git add . && git commit -m "Fix: ..." && git push`
3. Railway自動デプロイ待機（1-2分）
4. https://faqsystem-production.up.railway.app/admin/auto_generate_faq にアクセス
5. 「FAQ生成履歴をクリア」ボタンをクリック
6. 「FAQ自動生成を実行」ボタンをクリック
7. 承認待ち画面で生成内容を確認
8. トピックの多様性をチェック

## 環境情報

### デプロイ環境
- **プラットフォーム**: Railway
- **URL**: https://faqsystem-production.up.railway.app
- **Git リポジトリ**: https://github.com/kyuwatanabe/faq_system.git
- **ブランチ**: main（自動デプロイ）

### ローカル環境
- **パス**: `C:\Users\GF001\Desktop\システム開発\手引き用チャットボット\faq_system`
- **Python**: 不明（Railwayで実行）
- **Git状態**: main ブランチ、最新コミット 0b118a7

### 環境変数（Railway設定済み）
- `CLAUDE_API_KEY`: sk-ant-api... （設定済み、動作確認済み）

## データファイル

### CSV構造
1. **faq_data-1.csv**: 承認済みFAQ（現在0件）
2. **pending_qa.csv**: 承認待ちFAQ（最大20件表示）
3. **faq_generation_history.csv**: 生成履歴（重複チェックには使用しない）

### .gitignoreの状態
- `reference_docs/` はコメントアウト済み（デプロイに含まれる）
- `faq_generation_history.csv` は除外（履歴ファイル）

## ユーザーからのフィードバック

### 重要な要望
1. ✅ 「いちいち確認作業をさせないで」→ デバッグモード実装済み
2. ✅ 「ファイル選択不要にして」→ 実装済み
3. ❌ **「10ページ以上ある資料から数10しかユニークなFAQが作れないってことある？」**
   - これが現在の未解決問題の核心
   - ユーザーは「技術的に不可能なはずがない」と考えている
   - 正しい指摘: PDFには多様なトピックがあるのに偏りが発生

### 作業スタイル
- 短期的・実用的な解決を好む
- 複雑な実装よりシンプルな解決を優先
- エラーは自分で確認させるのではなく、事前にチェックしてほしい

## 最後のGitコミット
```
commit 0b118a7
Fix: 履歴ファイルチェックを削除して承認済みと承認待ちのみで重複チェック
```

## 次回の最優先タスク
**FAQ生成のトピック偏り問題を解決する**

推奨アプローチ:
1. まず利用可能なClaudeモデル（特にSonnet 3.5）を調査
2. temperature設定を追加
3. プロンプトにFew-shot exampleを追加
4. 上記を組み合わせてテスト

---

**作業再開時はこのファイルをClaude Codeに読み込ませてください**
