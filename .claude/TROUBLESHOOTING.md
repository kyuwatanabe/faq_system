# トラブルシューティング履歴

過去に発生した問題と解決方法を記録しています。

## 2025-10-08: FAQ一括削除が動作しない問題

### 症状
- 複数のFAQにチェックを入れて「まとめて削除」ボタンを押しても、1件ずつしか削除されない
- チェックボックスは視覚的に選択されているが、実際には機能していなかった

### 原因
1. **HTMLテンプレートのフォームネスト問題**
   - バッチ削除フォーム `<form id="batch-delete-form">` の中に編集フォームが配置されていた
   - HTMLの仕様上、フォームのネストは許可されていないため、ブラウザが自動的に構造を修正
   - 結果、チェックボックスが正しくフォームに紐付けられなかった

2. **ブラウザキャッシュ問題**
   - テンプレートを修正しても、古いHTMLがブラウザにキャッシュされていた
   - サーバーを再起動してもブラウザ側のキャッシュは残る

### 解決方法

#### コード修正
`templates/admin.html` の構造を修正：

```html
<!-- バッチ削除フォーム -->
<form id="batch-delete-form" method="POST" action="/admin/batch_delete">
{% for faq in faqs %}
<div class="faq-item">
    <div class="faq-checkbox">
        <input type="checkbox" name="faq_indices" value="{{ loop.index0 }}" class="faq-select">
    </div>
    <!-- FAQコンテンツ -->
</div>
{% endfor %}
</form>

<!-- 編集フォームは外に配置 -->
{% for faq in faqs %}
<div class="edit-form" id="edit-form-{{ loop.index0 }}">
    <form action="/admin/edit/{{ loop.index0 }}" method="post">
        <!-- 編集フォームの内容 -->
    </form>
</div>
{% endfor %}
```

#### キャッシュクリア手順
1. `Ctrl + Shift + Delete` でブラウザキャッシュをクリア
2. ブラウザを完全に閉じて再起動
3. `Ctrl + Shift + R` でスーパーリロード

#### 確認方法
開発者ツール（F12）のConsoleで以下を実行：

```javascript
// 編集フォームがバッチ削除フォームの外にあることを確認（falseになるべき）
document.getElementById('batch-delete-form').innerHTML.includes('edit-form')

// チェックボックスが正しく認識されているか確認
document.querySelectorAll('.faq-select:checked').length  // チェックした数と一致すべき
```

### 教訓
- HTMLテンプレートを修正した際は、必ずブラウザキャッシュをクリアする
- フォームのネストは絶対に避ける
- 動作確認は開発者ツールで実際のHTML構造を確認する

---

## 2025-10-08: FAQ自動生成で資料外の内容が生成される問題

### 症状
- PDFから自動生成する際、PDF資料に記載されていない一般的なビザ知識が生成されてしまう
- 承認待ちをクリアして再生成すると、同じFAQが再度生成される

### 原因
1. **プロンプトの制約が弱い**
   - 「PDFドキュメントから生成」とあるが、「PDFに記載されている内容のみ」という明示的な制約がなかった
   - Claude APIが一般知識を使って補完してしまっていた

2. **重複チェックの不足**
   - 既存FAQと承認待ちQ&Aのみチェックしていた
   - 過去に却下したFAQの履歴が残っていなかった

### 解決方法

#### プロンプト修正（faq_system.py: 680-695行目）
```python
【生成要件】
1. **最重要**: PDFドキュメントに明示的に記載されている内容のみからFAQを生成すること
2. PDFに記載されていない一般知識や推測による内容は絶対に含めないこと
3. 実用的で具体的な質問を作成する
...
【重要な注意事項】
- PDFドキュメントに記載されている事実のみを使用してください
- 一般的なビザ知識や外部情報を追加しないでください
- 不明な点や記載がない内容については、FAQを生成しないでください
```

#### 生成履歴機能の追加
1. `_load_generation_history()` - 過去の生成履歴を読み込み
2. `_save_to_generation_history()` - 生成したFAQを `faq_generation_history.csv` に保存
3. 重複チェックに履歴を追加: 既存FAQ + 承認待ちQ&A + **生成履歴**

### 教訓
- AIへの指示は「最重要」「絶対に」など強い表現で明示する
- 重複チェックは「完全一致」だけでなく「履歴」も含める
- ただし、類似トピックでも異なる角度からの質問は許容する

---

## よくある問題と対処法

### サーバーが起動しない
- **ポート5000が既に使用されている**: 既存のプロセスを終了するか、別のポートを使用
- **モジュールが見つからない**: `pip install -r requirements.txt` で依存関係をインストール

### Railway上でデプロイが失敗する
- **ビルドエラー**: `requirements.txt` が正しいか確認
- **起動エラー**: `Procfile` や起動コマンドが正しいか確認
- **環境変数**: Railwayの設定で必要な環境変数が設定されているか確認

### データが保存されない
- **CSVファイルの権限**: ファイルが読み取り専用になっていないか確認
- **パスの問題**: 相対パスではなく正しいパスでCSVを読み書きしているか確認
